<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Hacker Green P2P Call</title>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<style>
body { background:black; color:#00ff00; font-family:monospace; text-align:center; padding:30px; }
.popup { position:fixed; top:20px; left:50%; transform:translateX(-50%);
        background:rgba(0,255,0,0.2); padding:10px 20px; border:1px solid #00ff00;
        border-radius:8px; display:none; }
button { background:black; color:#00ff00; border:1px solid #00ff00; padding:10px 15px; margin:5px; cursor:pointer; border-radius:8px; }
input { background:black; color:#00ff00; border:1px solid #00ff00; padding:8px; margin:5px; width:200px; }
#callTimer { margin-top:10px; font-size:18px; }
</style>
</head>
<body>

<h2>ðŸ“ž Hacker Green P2P Call</h2>

<p id="my-number"></p>

<input type="text" id="remoteNumber" placeholder="Enter friend's number">
<br>
<button onclick="startCall()">Call</button>
<button onclick="endCall()">End Call</button>
<button onclick="toggleSpeaker()">ðŸ”Š Speaker</button>

<div id="callTimer">Call Time: 00:00</div>
<div id="popup" class="popup"></div>

<script>
  // -------- Temp Number --------
  function generateTempNumber() {
    return "9957" + Math.floor(100000 + Math.random() * 900000);
  }
  const myTempNumber = generateTempNumber();
  document.getElementById("my-number").innerText = "Your Temp Number: " + myTempNumber;

  // -------- Popup --------
  function showPopup(msg) {
    const popup = document.getElementById("popup");
    popup.innerText = msg;
    popup.style.display = "block";
    setTimeout(() => popup.style.display = "none", 2000);
  }

  // -------- PeerJS Init --------
  const peer = new Peer(myTempNumber, {
    host: "web-call-zen9.onrender.com",
    port: 443,
    path: "/myapp",
    secure: true
  });

  let currentCall = null;
  let callStartTime = null;
  let timerInterval = null;
  let speakerOn = false;
  let remoteAudio = null;

  peer.on("open", (id) => showPopup("Connected with ID: " + id));

  peer.on("call", call => {
    showPopup("Incoming Call...");
    navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
      call.answer(stream);
      bindCallEvents(call);
    });
  });

  function startCall() {
    const remoteId = document.getElementById("remoteNumber").value.trim();
    if (!remoteId) return showPopup("Enter number first!");
    navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
      const call = peer.call(remoteId, stream);
      bindCallEvents(call);
      showPopup("Calling " + remoteId + "...");
    });
  }

  function bindCallEvents(call) {
    currentCall = call;
    callStartTime = Date.now();

    timerInterval = setInterval(() => {
      const diff = Date.now() - callStartTime;
      const min = String(Math.floor(diff/60000)).padStart(2,"0");
      const sec = String(Math.floor(diff/1000)%60).padStart(2,"0");
      document.getElementById("callTimer").innerText = `Call Time: ${min}:${sec}`;
    }, 1000);

    call.on("stream", remoteStream => {
      if (!remoteAudio) {
        remoteAudio = document.createElement("audio");
        remoteAudio.autoplay = true;
        document.body.appendChild(remoteAudio);
      }
      remoteAudio.srcObject = remoteStream;
      showPopup("Call Connected");
    });

    call.on("close", () => {
      showPopup("Call Ended");
      clearInterval(timerInterval);
      document.getElementById("callTimer").innerText = "Call Time: 00:00";
    });
  }

  function endCall() {
    if (currentCall) {
      currentCall.close();
      currentCall = null;
      clearInterval(timerInterval);
      document.getElementById("callTimer").innerText = "Call Time: 00:00";
      showPopup("Call Ended");
    }
  }

  function toggleSpeaker() {
    if (!remoteAudio) return;
    speakerOn = !speakerOn;
    remoteAudio.muted = !speakerOn;
    showPopup(speakerOn ? "Speaker ON" : "Speaker OFF");
  }
</script>

</body>
</html>
