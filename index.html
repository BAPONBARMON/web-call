<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Web P2P Call</title>
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <style>
    body { background:black; color:lime; font-family:monospace; text-align:center; }
    .popup { position:fixed; top:20px; left:50%; transform:translateX(-50%);
             background:rgba(0,255,0,0.2); padding:10px 20px; border:1px solid lime;
             border-radius:8px; display:none; }
    button { background:black; color:lime; border:1px solid lime; padding:10px 15px; margin:5px; cursor:pointer; }
    #callTimer { margin-top:10px; font-size:18px; }
  </style>
</head>
<body>
  <h2>ðŸ“ž Web P2P Call</h2>
  <p>Your Temp Number: <b id="myNumber"></b></p>

  <input type="text" id="remoteId" placeholder="Enter remote number">
  <button onclick="makeCall()">Call</button>
  <button onclick="endCall()">End Call</button>
  <button onclick="toggleSpeaker()">ðŸ”Š Speaker</button>

  <div id="callTimer">Call Duration: 00:00</div>

  <div id="popup" class="popup"></div>

  <script>
    // -------- Temp Number Generator --------
    function generateTempNumber() {
      return "9957" + Math.floor(100000 + Math.random() * 899999);
    }
    const myTempNumber = generateTempNumber();
    document.getElementById("myNumber").textContent = myTempNumber;

    // -------- PeerJS Init with Backend --------
    const peer = new Peer(myTempNumber, {
      host: "web-call-zen9.onrender.com",  // ðŸ”¥ Render backend
      port: 443,
      path: "/myapp",
      secure: true
    });

    let currentCall = null;
    let callStartTime = null;
    let timerInterval = null;
    let speakerOn = false;

    peer.on("open", (id) => showPopup("Connected with ID: " + id));

    peer.on("call", (call) => {
      navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
        call.answer(stream);
        bindCallEvents(call);
      });
    });

    function makeCall() {
      const remoteId = document.getElementById("remoteId").value;
      if (!remoteId) return showPopup("Enter a number to call");
      navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
        const call = peer.call(remoteId, stream);
        bindCallEvents(call);
      });
    }

    function bindCallEvents(call) {
      currentCall = call;
      callStartTime = Date.now();
      startTimer();

      call.on("stream", (remoteStream) => {
        const audio = document.createElement("audio");
        audio.srcObject = remoteStream;
        audio.autoplay = true;
        audio.id = "remoteAudio";
        document.body.appendChild(audio);
        showPopup("Call Connected");
      });

      call.on("close", () => {
        stopTimer();
        showPopup("Call Ended");
      });
    }

    function endCall() {
      if (currentCall) {
        currentCall.close();
        currentCall = null;
        stopTimer();
        showPopup("Call Ended");
      }
    }

    function toggleSpeaker() {
      const audio = document.getElementById("remoteAudio");
      if (audio) {
        speakerOn = !speakerOn;
        audio.muted = !speakerOn;
        showPopup(speakerOn ? "Speaker ON" : "Speaker OFF");
      }
    }

    // -------- Timer --------
    function startTimer() {
      timerInterval = setInterval(() => {
        const diff = Date.now() - callStartTime;
        const sec = Math.floor(diff / 1000) % 60;
        const min = Math.floor(diff / 60000);
        document.getElementById("callTimer").textContent =
          `Call Duration: ${String(min).padStart(2,"0")}:${String(sec).padStart(2,"0")}`;
      }, 1000);
    }

    function stopTimer() {
      clearInterval(timerInterval);
      document.getElementById("callTimer").textContent = "Call Duration: 00:00";
    }

    // -------- Popup --------
    function showPopup(msg) {
      const popup = document.getElementById("popup");
      popup.innerText = msg;
      popup.style.display = "block";
      setTimeout(() => popup.style.display = "none", 2000);
    }
  </script>
</body>
</html>
